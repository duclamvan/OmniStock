To transform your WMS from a simple tracking tool into a "Business Intelligence" engine that actively advises you, you need to implement a strategy I call **"Snapshot & Analyze."**

Instead of asking AI to read your entire raw database (which is slow, expensive, and unsafe), you should build a system that **aggregates** key metrics daily and then feeds a *summary* to the AI for high-level advice.

Here is the step-by-step implementation plan.

### 1\. The Strategy: "Snapshot & Analyze"

You need a dedicated place to store daily business health metrics. This allows you to track trends over time (e.g., "Is my cash flow better than last month?") and gives the AI a clean data set to work with.

**Step A: Update Database Schema**
Add a new table to store daily financial and inventory snapshots.

```typescript
// Add to schema.ts
export const businessReports = pgTable("business_reports", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  date: date("date").notNull(), // The day this report covers
  
  // ðŸ’° Cash Flow Metrics
  revenue: decimal("revenue").notNull(),      // Total value of orders created
  cashCollected: decimal("cash_collected"),   // Actual payments received (Bank/Cash)
  expenses: decimal("expenses"),              // Money spent (Supplier POs + Operational Expenses)
  netCashFlow: decimal("net_cash_flow"),      // cashCollected - expenses
  
  // ðŸ“¦ Inventory Health
  totalStockValue: decimal("total_stock_value"),
  lowStockCount: integer("low_stock_count"),
  deadStockCount: integer("dead_stock_count"), // Items not sold in >90 days (Cash traps)
  
  // ðŸ“ˆ Growth Data
  topSellingItems: jsonb("top_selling_items"), // Store top 5: [{name: "Nail File", qty: 500}, ...]
  velocityAlerts: jsonb("velocity_alerts"),    // Items selling faster than expected
  
  // ðŸ¤– The Advice
  aiAnalysis: text("ai_analysis"), // The text advice generated by AI for this day
  createdAt: timestamp("created_at").defaultNow(),
});
```

-----

### 2\. Backend Implementation: The "Daily Crunch"

You need a backend function (e.g., `generateDailyReport`) that runs every night or on-demand.

**What it calculates:**

1.  **Cash Flow:** Sums all `orders` where `payment_status = 'paid'` vs. all `expenses` and `import_purchases`.
2.  **Reorder Needs (Velocity):** Instead of just checking if stock is low, it calculates **"Days Until Empty"**.
      * *Formula:* `Current Stock / Average Daily Sales (last 30 days)`.
      * *Result:* If "Days Until Empty" \< 7, flag it as **Urgent Reorder**.
3.  **Dead Stock:** Finds products with `quantity > 0` but `last_sold_at` \> 90 days ago. These are hurting your cash flow.

-----

### 3\. AI Integration: The "CFO Prompt"

Once the backend gathers the numbers above, it sends a specific prompt to OpenAI (or Anthropic).

**The Prompt Structure:**

> "Act as a CFO for a warehouse business. Here is today's snapshot:
>
>   - **Cash Flow:** -15,000 CZK (Spent more than collected).
>   - **Urgent Reorders:** 'Gel Polish A' (Will run out in 3 days), 'Acetone 5L' (Will run out in 5 days).
>   - **Dead Stock:** 50,000 CZK tied up in 'Old UV Lamps' (No sales in 6 months).
>   - **Top Seller:** 'Nail Files' (Velocity increased by 20%).
>
> **Task:** Provide 3 specific, short, actionable pieces of advice to improve cash flow and stability this week."

**Example AI Output (Saved to DB):**

1.  **Liquidation:** Run a "Buy 1 Get 1 Free" sale on the 'Old UV Lamps' immediately to unlock that 50,000 CZK cash.
2.  **Bulk Negotiation:** Since 'Nail Files' velocity is up 20%, order a double-batch now to negotiate a 5% discount with the supplier.
3.  **Cash Warning:** Stop non-essential expenses this week until the negative cash flow stabilizes.

-----

### 4\. Frontend Implementation: "Business Advisor" Dashboard

Create a new page in your WMS (`/dashboard/advisor`) that visualizes this data.

  * **Cash Flow Chart:** A line graph showing "Money In" vs "Money Out" over the last 30 days.
  * **"Urgent Actions" List:** A red list of items that need reordering *now* based on velocity logic.
  * **The AI Card:** A prominent box showing the latest "CFO Advice" generated from the nightly report.

### Summary of Actions

1.  **Migrate:** Create the `business_reports` table using the migration workflow we discussed.
2.  **Build:** Create the backend logic to aggregate sales/expenses into this table.
3.  **Integrate:** Connect OpenAI API to analyze that summary data.
4.  **Visualize:** Build the dashboard to show the graphs and advice.

This gives you exactly what you want: a "Cash Flow" view and smart, data-backed advice without risking your data or breaking the bank on API costs.